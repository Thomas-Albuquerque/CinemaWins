<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CinemaWins | Dashboard</title>
  <!-- CSS -->
  <link rel="stylesheet" href="style.css" />
  <!-- Boxicons CSS -->
  <link href="https://unpkg.com/boxicons@2.1.2/css/boxicons.min.css" rel="stylesheet" />
  <script src="https://kit.fontawesome.com/1458552bdc.js" crossorigin="anonymous"></script>
  <script src="../js/sessao.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body
  style="background-image: url(https://mithsd.carrd.co/assets/images/container20.jpg?v=16376974); background-size: cover;"
  onload="obterReviews(), verificarCurtida()">
  <nav>
    <div class="logo">
      <i style=" color: #e2e2e2;" class="bx bx-menu menu-icon"></i>
      <span class="logo-name">CinemaWins</span>
    </div>
    <div class="sidebar">
      <div class="logo">
        <i style=" color: #e2e2e2;" class="bx bx-menu menu-icon"></i>
        <span class="logo-name">CinemaWins</span>
      </div>

      <div class="sidebar-content">
        <ul class="lists">
          <li class="list">
            <a href="Dashboard.html" class="nav-link">
              <i class="bx bx-home-alt icon"></i>
              <span class="link">Dashboard</span>
            </a>
          </li>
          <li class="list">
            <a href="social.html" class="nav-link">
              <i class="bx bx-bar-chart-alt-2 icon"></i>
              <span class="link">Feed</span>
            </a>
          </li>
          <!-- <li class="list">
            <a href="#" class="nav-link">
              <i class="bx bx-bell icon"></i>
              <span class="link">Notifications</span>
            </a>
          </li> -->
          <!-- <li class="list">
            <a href="#" class="nav-link">
              <i class="bx bx-message-rounded icon"></i>
              <span class="link">Messages</span>
            </a>
          </li> -->
          <li class="list">
            <a href="historico.html" class="nav-link">
              <i class="bx bx-pie-chart-alt-2 icon"></i>
              <span class="link">Histórico de partidas</span>
            </a>
          </li>
          <!-- <li class="list">
            <a href="#" class="nav-link">
              <i class="bx bx-heart icon"></i>
              <span class="link">Likes</span>
            </a>
          </li> -->
          <!-- <li class="list">
            <a href="#" class="nav-link">
              <i class="bx bx-folder-open icon"></i>
              <span class="link">Files</span>
            </a>
          </li> -->
        </ul>

        <div class="bottom-cotent">
          <li class="list">
            <a href="#" class="nav-link">
              <i class="bx bx-cog icon"></i>
              <span class="link">Configurações</span>
            </a>
          </li>
          <li class="list">
            <a href="../index.html" class="nav-link">
              <i class="bx bx-log-out icon"></i>
              <span class="link">Sair</span>
            </a>
          </li>
        </div>
      </div>
    </div>
  </nav>
  <section class="overlay"></section>
  <div class="incial">
    <div class="texto-inicial">
      <p>Últimas postagens</p>
      <button id="openModalButton" class="button1 primary">
        <i class="fas fa-pencil-alt icon"></i>Faça um Review
      </button>
      <div class="modal hidden" id="myModal">
        <article class="modal-container">
          <header class="modal-container-header">
            <h1 class="modal-container-title">
              <svg style="color: #3C150A;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"
                aria-hidden="true">
                <path fill="none" d="M0 0h24v24H0z" />
                <path fill="currentColor"
                  d="M14 9V4H5v16h6.056c.328.417.724.785 1.18 1.085l1.39.915H3.993A.993.993 0 0 1 3 21.008V2.992C3 2.455 3.449 2 4.002 2h10.995L21 8v1h-7zm-2 2h9v5.949c0 .99-.501 1.916-1.336 2.465L16.5 21.498l-3.164-2.084A2.953 2.953 0 0 1 12 16.95V11zm2 5.949c0 .316.162.614.436.795l2.064 1.36 2.064-1.36a.954.954 0 0 0 .436-.795V13h-5v3.949z" />
              </svg>
              Review
            </h1>
            <button id="closeModalButton" class="icon-button">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                <path fill="none" d="M0 0h24v24H0z" />
                <path fill="currentColor"
                  d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95L7.05 5.636z" />
              </svg>
            </button>
          </header>
          <section class="modal-container-body rtf">
            <h2>Poste sua review e compartilhe seus pensamentos!</h2>
            <label for="reviewTitle">Título da Review:</label>
            <input type="text" id="reviewTitulo" name="reviewTitle" placeholder="Insira o título da review">

            <label for="reviewDescription">Descrição da Review:</label>
            <textarea id="reviewDescricao" name="reviewDescription"
              placeholder="Insira a descrição da review"></textarea>
          </section>
          <footer class="modal-container-footer">
            <button id="cancelButton" class="button is-ghost">Cancelar</button>
            <button style="background-color: #3C150A;" onclick="cadastrarReview()"
              class="button is-primary">Postar</button>
          </footer>
        </article>
      </div>
    </div>
    <hr class="centered-hr">
    <div class="container-filmCard">
      <!-- <div class="filmCard">
        <div class="img"></div>
        <div class="user-container">
          <div class="user">
            <div class="icon-user"></div>
            <p>Nome do user</p>
          </div>
          <h2 style="color: white;">Titulo Review</h2> <span
            style="color: rgb(173, 173, 173); font-size: 13px;">31/05/2024</span>
          <p class="description">meowmeomwoemwomeowmeomwomowmeomwomeomwomeow
            meowmeomwoemwomeowmeomwomowmeomwomeomwomeow
            meowmeomwoemwomeowmeomwomowmeomwomeomwomeow
            meowmeomwoemwomeowmeomwomowmeomwomeomwomeow
            meowmeomwoemwomeowmeomwomowmeomwomeomwomeow
            meowmeomwoemwomeowmeomwomowmeomwomeomwomeow
          </p>
          <div class="container-curtida">
            <i onclick="mudarCor()" id="curtidaFoda" class="fa-regular fa-heart icone-curtida"></i>
            <span>Curtir review</span>
            <div class="container-textoLike">
              <span>2,000 curtidas</span>
            </div>
          </div>
        </div> -->
      <!-- </div>
      <div class="filmCard">
        <div class="img"></div>
        <div class="user-container">
          <div class="user">
            <div class="icon-user"></div>
            <p>Nome do user</p>
          </div>
          <h2 style="color: white;">Titulo Review</h2> <span
            style="color: rgb(173, 173, 173); font-size: 13px;">31/05/2024</span>
          <p class="description">meowmeomwoemwomeowmeomwomowmeomwomeomwomeow
            meowmeomwoemwomeowmeomwomowmeomwomeomwomeow
            meowmeomwoemwomeowmeomwomowmeomwomeomwomeow
            meowmeomwoemwomeowmeomwomowmeomwomeomwomeow
            meowmeomwoemwomeowmeomwomowmeomwomeomwomeow
            meowmeomwoemwomeowmeomwomowmeomwomeomwomeow
          </p>
          <div class="container-curtida">
            <i onclick="mudarCor()" id="curtidaFoda" class="fa-regular fa-heart icone-curtida"></i>
            <span>Curtir review</span>
            <div class="container-textoLike">
              <span>2,000 curtidas</span>
            </div>
          </div>
        </div> -->
    </div>
  </div>
  </div>
</body>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    document.getElementById("openModalButton").addEventListener("click", function () {
      var modal = document.getElementById("myModal");
      modal.classList.toggle("hidden");
    });

    document.getElementById("closeModalButton").addEventListener("click", function () {
      var modal = document.getElementById("myModal");
      modal.classList.add("hidden");
    });

    document.getElementById("cancelButton").addEventListener("click", function () {
      var modal = document.getElementById("myModal");
      modal.classList.add("hidden");
    });
  });

  const userId = sessionStorage.getItem('ID_USUARIO');

  function cadastrarReview() {
    var tituloVar = document.getElementById("reviewTitulo").value;
    var descricaoVar = document.getElementById("reviewDescricao").value;

    if (tituloVar === "" || descricaoVar === "") {
      alert("Por favor, preencha todos os campos");
    }

    fetch("/usuarios/cadastrarReview", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        usuarioIdServer: sessionStorage.getItem('ID_USUARIO'),
        tituloServer: tituloVar,
        descricaoServer: descricaoVar,
      }),
    })
      .then(function (resposta) {
        console.log("resposta: ", resposta);

        if (resposta.ok) {
          console.log("Review cadastrado com sucesso!");
          var modal = document.getElementById("myModal");
          modal.classList.add("hidden"); // Fecha o modal
          location.reload(); // Recarrega a página
        } else {
          throw "Houve um erro ao tentar cadastrar a review!";
        }
      })
      .catch(function (erro) {
        console.log("#ERRO: ", erro);
      });

    return false;
  }

  function obterReviews() {
    fetch("/usuarios/obterReviews")
      .then(function (resposta) {
        if (resposta.ok) {
          return resposta.json();
        } else {
          throw "Erro ao obter as reviews!";
        }
      })
      .then(function (reviews) {
        console.log("Reviews obtidas:", reviews);
        mostrarReviews(reviews);
      })
      .catch(function (erro) {
        console.log("#ERRO: ", erro);
      });
  }

  function mostrarReviews(reviews) {
    var containerReviews = document.querySelector(".container-filmCard");

    reviews.forEach((review) => {
        var reviewCard = document.createElement("div");
        reviewCard.classList.add("filmCard");

        var likeIcon = document.createElement("i");
        likeIcon.classList.add("fa-regular", "fa-heart", "icone-curtida");
        likeIcon.onclick = function () {
            mudarCurtida(review.idReview, sessionStorage.getItem('ID_USUARIO'));
        };
        likeIcon.id = `curtida_${review.idReview}`;

        var imgDiv = document.createElement("div");
        imgDiv.classList.add("img");

        var userContainer = document.createElement("div");
        userContainer.classList.add("user-container");

        var userDiv = document.createElement("div");
        userDiv.classList.add("user");

        var iconUser = document.createElement("div");
        iconUser.classList.add("icon-user");
        var icon = document.createElement("i");
        icon.classList.add("fa-solid", "fa-user");
        iconUser.appendChild(icon);

        var userName = document.createElement("p");
        userName.textContent = review.nome;

        var title = document.createElement("h2");
        title.textContent = review.titulo;
        title.style.color = "white";

        var date = document.createElement("span");
        date.textContent = review.data_publicacao_formatada;
        date.style.color = "rgb(173, 173, 173)";
        date.style.fontSize = "13px";

        var description = document.createElement("p");
        description.classList.add("description");
        description.textContent = review.descricao;

        var likeContainer = document.createElement("div");
        likeContainer.classList.add("container-curtida");

        var likeText = document.createElement("span");
        likeText.textContent = "Curtir review";

        var likeCount = document.createElement("div");
        likeCount.classList.add("container-textoLike");
        likeCount.innerHTML = `<span>${review.total_curtidas} curtidas</span>`; // Aqui está o total de curtidas

        likeContainer.appendChild(likeIcon);
        likeContainer.appendChild(likeText);
        likeContainer.appendChild(likeCount);

        userDiv.appendChild(iconUser);
        userDiv.appendChild(userName);

        userContainer.appendChild(userDiv);
        userContainer.appendChild(title);
        userContainer.appendChild(date);
        userContainer.appendChild(description);
        userContainer.appendChild(likeContainer);

        reviewCard.appendChild(imgDiv);
        reviewCard.appendChild(userContainer);

        containerReviews.appendChild(reviewCard);

        verificarCurtida(review.idReview, sessionStorage.getItem('ID_USUARIO'));
    });
}


function mudarCor(reviewId) {
    let icon = document.getElementById(`curtida_${reviewId}`);
    icon.classList.toggle("fa-regular");
    icon.classList.toggle("fa-solid");
    icon.classList.toggle("curtida");

    var likeCount = document.querySelector(`#curtida_${reviewId} + .container-textoLike span`);
    var curtidas = parseInt(likeCount.textContent);
    likeCount.textContent = curtidas + " curtidas"; // Apenas atualiza o texto sem somar 1
}

function verificarCurtida(reviewId) {
    fetch(`/usuarios/verificarCurtida?reviewId=${reviewId}&userId=${userId}`)
        .then(response => response.json())
        .then(data => {
            const likeIcon = document.getElementById(`curtida_${reviewId}`);
            const likeCount = document.querySelector(`#curtida_${reviewId} + .container-textoLike span`);

            if (data.curtiu) {
                likeIcon.classList.add("fa-solid", "curtida");
                likeIcon.classList.remove("fa-regular");
            } else {
                likeIcon.classList.add("fa-regular");
                likeIcon.classList.remove("fa-solid", "curtida");
            }

            likeCount.textContent = `${data.totalCurtidas} curtidas`;
        })
        .catch(error => console.error('Erro ao verificar curtida:', error));
}

function mudarCurtida(reviewId) {
    const likeIcon = document.getElementById(`curtida_${reviewId}`);

    fetch(`/usuarios/toggleCurtida`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({
            reviewId: reviewId,
            userId: userId
        }),
    })
        .then(response => response.json())
        .then(data => {
            if (data.curtiu) {
                likeIcon.classList.add("fa-solid", "curtida");
                likeIcon.classList.remove("fa-regular");
            } else {
                likeIcon.classList.add("fa-regular");
                likeIcon.classList.remove("fa-solid", "curtida");
            }

            const likeCount = document.querySelector(`#curtida_${reviewId} + .container-textoLike span`);
            likeCount.textContent = `${data.totalCurtidas} curtidas`;
        })
        .catch(error => console.error('Erro ao alternar curtida:', error));

        location.reload();
}

</script>
<script src="script.js"></script>