<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CinemaWins | Dashboard</title>
  <!-- CSS -->
  <link rel="stylesheet" href="style.css" />
  <!-- Boxicons CSS -->
  <link href="https://unpkg.com/boxicons@2.1.2/css/boxicons.min.css" rel="stylesheet" />
  <script src="../js/sessao.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body style="background-image: url(https://mithsd.carrd.co/assets/images/container03.jpg?v=16376974); background-size: cover;">
  <nav>
    <div class="logo">
      <i style=" color: #e2e2e2;" class="bx bx-menu menu-icon"></i>
      <span class="logo-name">CinemaWins</span>
    </div>
    <div class="sidebar">
      <div class="logo">
        <i style=" color: #e2e2e2;" class="bx bx-menu menu-icon"></i>
        <span class="logo-name">CinemaWins</span>
      </div>

      <div class="sidebar-content">
        <ul class="lists">
          <li class="list">
            <a href="#" class="nav-link">
              <i class="bx bx-home-alt icon"></i>
              <span class="link">Dashboard</span>
            </a>
          </li>
          <li class="list">
            <a href="social.html" class="nav-link">
              <i class="bx bx-bar-chart-alt-2 icon"></i>
              <span class="link">Feed</span>
            </a>
          </li>
          <!-- <li class="list">
            <a href="#" class="nav-link">
              <i class="bx bx-bell icon"></i>
              <span class="link">Notifications</span>
            </a>
          </li> -->
          <!-- <li class="list">
            <a href="#" class="nav-link">
              <i class="bx bx-message-rounded icon"></i>
              <span class="link">Messages</span>
            </a>
          </li> -->
          <li class="list">
            <a href="historico.html" class="nav-link">
              <i class="bx bx-pie-chart-alt-2 icon"></i>
              <span class="link">Histórico de partidas</span>
            </a>
          </li>
          <!-- <li class="list">
            <a href="#" class="nav-link">
              <i class="bx bx-heart icon"></i>
              <span class="link">Likes</span>
            </a>
          </li> -->
          <!-- <li class="list">
            <a href="#" class="nav-link">
              <i class="bx bx-folder-open icon"></i>
              <span class="link">Files</span>
            </a>
          </li> -->
        </ul>

        <div class="bottom-cotent">
          <li class="list">
            <a href="#" class="nav-link">
              <i class="bx bx-cog icon"></i>
              <span class="link">Configurações</span>
            </a>
          </li>
          <li class="list">
            <a href="../index.html" class="nav-link">
              <i class="bx bx-log-out icon"></i>
              <span class="link">Sair</span>
            </a>
          </li>
        </div>
      </div>
    </div>
  </nav>
  <section class="overlay"></section>
  <div class="incial">
    <div class="container-metricas">
      <div class="metricas">
        <p>Total de vezes jogadas</p>
        <p id="total-jogadas" style="font-size:19px; color: #181818; font-weight: 800;">0</p>
      </div>
      <div class="metricas">
        <p>Maior pontuação</p>
        <p id="maior-pontuacao" style="font-size:19px; color: #181818; font-weight: 800;">0</p>
      </div>
      <div class="metricas">
        <p>Menor pontuação</p>
        <p id="menor-pontuacao" style="font-size:19px; color: #181818; font-weight: 800;">0</p>
      </div>
      <div class="metricas">
        <p>Pontuação Total</p>
        <p id="total-pontuacao" style="font-size:19px; color:#181818; font-weight: 800;">0</p>
      </div>
    </div>
    <div class="container-cardUser">
      <div class="cardUser">
        <p>Bem vindo(a) de volta,</p>
        <p style="font-size: 28px; color:#181818; font-weight: 900;"><span id="nome_Usuario"></span></p>
        <h5>Prepare-se <br>para alcançar <br>o TOP 1!</h5>
      </div>
      <div class="metricasUser">
        <div class="total-container">
          <div class="total-user">
            <p style="  margin-right: 10%; margin-bottom: 2%;">Cinéfilos cadastrados<br>no projeto</p>
            <span style="  margin-bottom: 10%;
            " id="total_usuarios"></span>
          </div>
        </div>
      </div>
    <div class="dashboardTop3">
  <div class="chart-container">
    <canvas id="myChart"></canvas>
  </div>
</div>
    </div>
    <div class="container-ranking">
      <div class="ranking">
        <p>Ranking de Pontuação</p>
        <table class="ranking-table">
          <thead>
            <tr>
              <th>Posição</th>
              <th>Usuário</th>
              <th>Pontuação</th>
              <th>Vezes jogadas</th>
            </tr>
          </thead>
          <div class="scrollable-tbody">
            <tbody id="ranking-body">
              <!-- Ranking rows will be inserted here by JavaScript -->
            </tbody>
          </div>
        </table>
      </div>
      <div class="jogos">
        <p>Quizes</p>
        <p style="font-size: 15px; font-weight: 100;">Jogue agora e teste seus conhecimentos em diferentes areas do cinema</p>
        <div class="center">
          <div onclick="irParaQuiz()" style="background-image: url(https://images.unsplash.com/photo-1489599849927-2ee91cede3ba?q=80&w=1470&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D);background-repeat: no-repeat;background-size: cover;" class="article-card">
            <div class="content">
              <p class="date">Mar 31, 2024</p>
              <p class="title">Conhecimentos Gerais</p>
            </div>
          </div>
          <div onclick="irParaQuizTerror()" style="background-image: url(https://i.pinimg.com/564x/c9/cd/e5/c9cde5d0a8514e5c4894fc0c852a9a76.jpg);background-repeat: no-repeat;background-size: cover;" class="article-card">
            <div class="content">
              <p class="date">Mar 31, 2024</p>
              <p class="title">Gênero Terror</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    

  <script>
    const labels = [];
    const data = {
      labels: labels,
      datasets: [{
        label: 'Pontuação',
        data: [65, 59, 80, 81, 56, 55, 40],
        backgroundColor: [
          'rgb(173,10,20, 0.4)',
        ],
        borderColor: [
          '#81171B',
        ],
        borderWidth: 1

      }]
    };
    const config = {
            type: 'bar',
            data: data,
            options: {
                plugins: {
                    title: {
                        display: true,
                        text: 'Top 3 Pontuações',
                        font: {
                            size: 24,
                            weight: '500'
                        },
                        color: 'white' 
                    },
                    legend: {
                        labels: {
                            color: 'white' 
                        }
                    },
                    tooltip: {
                        bodyColor: 'white', 
                        titleColor: 'black',
                        backgroundColor: 'rgba(174, 146, 132, 0.8)', 
                        titleFont: {
                            size: 14, 
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 16, 
                        },
                        callbacks: {
                            labelColor: function(context) {
                                return {
                                    borderColor: 'rgba(0, 0, 0, 0.3)',
                                    backgroundColor: 'white'
                                };
                            },
                            labelTextColor: function() {
                                return 'black';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: 'white' 
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: 'white' 
                        }
                    }
                }
            }
        };
        
    const myChart = new Chart(
      document.getElementById('myChart'),
      config
    );

    function irParaQuiz() {
      window.location = "../tela_inicial.html"
    }

    function irParaQuizTerror() {
      window.location = "../tela_inicial2.html"
    }


    function vezesJogadas() {

      console.log("ID do usuário enviado para obterTotalJogadas:", sessionStorage.getItem('ID_USUARIO'));

      fetch(`/usuarios/vezesJogadas?usuarioId=${sessionStorage.getItem('ID_USUARIO')}`, {
        method: "GET",
        headers: {
          "Content-Type": "application/json"
        }
      })
        .then(function (resposta) {
          if (!resposta.ok) {
            throw new Error("Erro ao obter o total de jogadas.");
          }
          return resposta.json();
        })
        .then(function (data) {
          console.log("Total de vezes jogadas: ", data.total_jogadas);
          document.getElementById("total-jogadas").innerText = data.total_jogadas;
        })
        .catch(function (erro) {
          console.error("Erro ao obter o total de jogadas: ", erro);
        });
    }


    function obterMaiorPontuacao() {
      fetch(`/usuarios/maiorPontuacao?usuarioId=${sessionStorage.getItem('ID_USUARIO')}`, {
        method: "GET",
        headers: {
          "Content-Type": "application/json"
        }
      })
        .then(function (resposta) {
          if (!resposta.ok) {
            throw new Error("Erro ao obter a maior pontuação.");
          }
          return resposta.json();
        })
        .then(function (data) {
          console.log("Maior pontuação: ", data.maior_pontuacao);
          document.getElementById("maior-pontuacao").innerText = data.maior_pontuacao;
        })
        .catch(function (erro) {
          console.error("Erro ao obter a maior pontuação: ", erro);
        });
    }


    function obterMenorPontuacao() {
      fetch(`/usuarios/menorPontuacao?usuarioId=${sessionStorage.getItem('ID_USUARIO')}`, {
        method: "GET",
        headers: {
          "Content-Type": "application/json"
        }
      })
        .then(function (resposta) {
          if (!resposta.ok) {
            throw new Error("Erro ao obter a menor pontuação.");
          }
          return resposta.json();
        })
        .then(function (data) {
          console.log("Menor pontuação: ", data.menor_pontuacao);
          document.getElementById("menor-pontuacao").innerText = data.menor_pontuacao;
        })
        .catch(function (erro) {
          console.error("Erro ao obter a menor pontuação: ", erro);
        });
    }

    function obterTotalPontuacao() {
      fetch(`/usuarios/totalPontuacao?usuarioId=${sessionStorage.getItem('ID_USUARIO')}`, {
        method: "GET",
        headers: {
          "Content-Type": "application/json"
        }
      })
        .then(function (resposta) {
          if (!resposta.ok) {
            throw new Error("Erro ao obter a total de pontuação.");
          }
          return resposta.json();
        })
        .then(function (data) {
          console.log("Total de pontuação: ", data.total_pontuacao);
          document.getElementById("total-pontuacao").innerText = data.total_pontuacao;
        })
        .catch(function (erro) {
          console.error("Erro ao obter a total de pontuação: ", erro);
        });
    }

    function obterTresMaioresPontuacoes() {
      fetch(`/usuarios/obterTresMaioresPontuacoes?usuarioId=${sessionStorage.getItem('ID_USUARIO')}`, {
        method: "GET",
        headers: {
          "Content-Type": "application/json"
        }
      })
        .then(function (resposta) {
          if (!resposta.ok) {
            throw new Error("Erro ao obter as três maiores pontuações.");
          }
          return resposta.json();
        })
        .then(function (data) {
          console.log("Três maiores pontuações: ", data);

          const nomes = data.map(pontuacao => pontuacao.nome);
          const pontuacoes = data.map(pontuacao => parseInt(pontuacao.total_pontuacao));

          myChart.data.labels = nomes;
          myChart.data.datasets[0].data = pontuacoes;

          myChart.update();
        })
        .catch(function (erro) {
          console.error("Erro ao obter as três maiores pontuações: ", erro);
        });
    }

    function nomeUsuario() {

      console.log("ID do usuário enviado para obterTotalJogadas:", sessionStorage.getItem('ID_USUARIO'));

      fetch(`/usuarios/nomeUsuario?usuarioId=${sessionStorage.getItem('ID_USUARIO')}`, {
        method: "GET",
        headers: {
          "Content-Type": "application/json"
        }
      })
        .then(function (resposta) {
          if (!resposta.ok) {
            throw new Error("Erro ao obter o total de jogadas.");
          }
          return resposta.json();
        })
        .then(function (data) {
          console.log("nome do usuário: ", data.nome_Usuario);
          document.getElementById("nome_Usuario").innerText = data.nome_Usuario;
        })
        .catch(function (erro) {
          console.error("Erro ao obter o total de jogadas: ", erro);
        });
    }

    function obterTotalUsuarios() {
    console.log("Obtendo o total de usuários cadastrados...");

    fetch('/usuarios/contarTotalUsuarios', {
        method: "GET",
        headers: {
            "Content-Type": "application/json"
        }
    })
    .then(function (resposta) { 
        if (!resposta.ok) {
            throw new Error("Erro ao obter o total de usuários.");
        }
        return resposta.json();
    })
    .then(function (data) {
        console.log("Total de usuários: ", data.total_usuarios);
        document.getElementById("total_usuarios").innerText = data.total_usuarios;
    })
    .catch(function (erro) {
        console.error("Erro ao obter o total de usuários: ", erro);
    });
}

function obterRankingPontuacao() {
            console.log("Obtendo o ranking de pontuação...");

            fetch('/usuarios/obterRankingPontuacao', {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                }
            })
            .then(function (resposta) {
                if (!resposta.ok) {
                    throw new Error("Erro ao obter o ranking de pontuação.");
                }
                return resposta.json();
            })
            .then(function (data) {
                console.log("Ranking de pontuação: ", data);
                atualizarRanking(data);
            })
            .catch(function (erro) {
                console.error("Erro ao obter o ranking de pontuação: ", erro);
            });
        }

        function atualizarRanking(data) {
    var rankingBody = document.getElementById("ranking-body");
    rankingBody.innerHTML = ""; 

    data.forEach((usuario, index) => {
        var row = `
            <tr>
                <td>${index + 1}º</td>
                <td>${usuario.nome}</td>
                <td>${usuario.total_pontuacao}</td>
                <td>${usuario.total_jogadas}</td>
            </tr>
        `;
        rankingBody.innerHTML += row;
    });
}

        

        window.onload = function () {
            vezesJogadas();
            obterMaiorPontuacao();
            obterMenorPontuacao();  
            obterTotalPontuacao();
            obterTresMaioresPontuacoes();
            nomeUsuario();
            obterTotalUsuarios();
            obterRankingPontuacao();
        };

  </script>
  <script src="script.js"></script>
</body>

</html>